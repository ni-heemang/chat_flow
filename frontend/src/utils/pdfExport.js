import jsPDF from 'jspdf';
import html2canvas from 'html2canvas';

export const exportAnalysisDataToPDF = async (analysisData, roomName) => {
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  let yPos = 20;

  // ì œëª© ì„¤ì •
  doc.setFontSize(20);
  doc.text(`ì±„íŒ… ë¶„ì„ ë³´ê³ ì„œ`, pageWidth / 2, yPos, { align: 'center' });
  yPos += 10;

  doc.setFontSize(14);
  doc.text(`ì±„íŒ…ë°©: ${roomName}`, pageWidth / 2, yPos, { align: 'center' });
  yPos += 10;

  doc.setFontSize(10);
  doc.text(`ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}`, pageWidth / 2, yPos, { align: 'center' });
  yPos += 20;

  // ê¸°ë³¸ í†µê³„
  if (analysisData.analysisStats) {
    const stats = analysisData.analysisStats;
    doc.setFontSize(16);
    doc.text('ğŸ“Š ê¸°ë³¸ í†µê³„', 20, yPos);
    yPos += 10;

    doc.setFontSize(12);
    doc.text(`â€¢ ì´ ë©”ì‹œì§€ ìˆ˜: ${stats.totalMessages || 0}ê°œ`, 25, yPos);
    yPos += 7;
    doc.text(`â€¢ í™œì„± ì‚¬ìš©ì: ${stats.activeUsers || 0}ëª…`, 25, yPos);
    yPos += 7;
    doc.text(`â€¢ í‰ê·  ì‘ë‹µ ì‹œê°„: ${stats.averageResponseTime || 0}ì´ˆ`, 25, yPos);
    yPos += 7;
    doc.text(`â€¢ ìµœê³  í™œë™ ì‹œê°„: ${stats.peakHour || 0}ì‹œ`, 25, yPos);
    yPos += 15;
  }

  // í‚¤ì›Œë“œ ë¶„ì„
  if (analysisData.keywordData?.topKeywords?.length > 0) {
    doc.setFontSize(16);
    doc.text('ğŸ” í‚¤ì›Œë“œ ë¶„ì„', 20, yPos);
    yPos += 10;

    doc.setFontSize(12);
    analysisData.keywordData.topKeywords.slice(0, 10).forEach((keyword, index) => {
      doc.text(`${index + 1}. ${keyword.keyword}: ${keyword.count}íšŒ`, 25, yPos);
      yPos += 7;
    });
    yPos += 10;
  }

  // ì°¸ì—¬ë„ ë¶„ì„
  if (analysisData.participationData?.userStats?.length > 0) {
    if (yPos > pageHeight - 50) {
      doc.addPage();
      yPos = 20;
    }

    doc.setFontSize(16);
    doc.text('ğŸ‘¥ ì°¸ì—¬ë„ ë¶„ì„', 20, yPos);
    yPos += 10;

    doc.setFontSize(12);
    analysisData.participationData.userStats.slice(0, 10).forEach((user, index) => {
      doc.text(`${index + 1}. ${user.username}: ${user.messageCount}ê°œ ë©”ì‹œì§€`, 25, yPos);
      yPos += 7;
    });
    yPos += 10;
  }

  // ì‹œê°„ë³„ í™œë™ ë¶„ì„
  if (analysisData.hourlyActivityData?.hourlyStats) {
    if (yPos > pageHeight - 50) {
      doc.addPage();
      yPos = 20;
    }

    doc.setFontSize(16);
    doc.text('â° ì‹œê°„ë³„ í™œë™ ë¶„ì„', 20, yPos);
    yPos += 10;

    doc.setFontSize(12);
    const hourlyStats = Object.entries(analysisData.hourlyActivityData.hourlyStats)
      .sort(([a], [b]) => parseInt(a) - parseInt(b))
      .slice(0, 12);

    hourlyStats.forEach(([hour, count]) => {
      doc.text(`â€¢ ${hour}ì‹œ: ${count}ê°œ ë©”ì‹œì§€`, 25, yPos);
      yPos += 7;
    });
    yPos += 10;
  }

  // ë¶„ì„ ìš”ì•½
  doc.setFontSize(16);
  doc.text('ğŸ“‹ ë¶„ì„ ìš”ì•½', 20, yPos);
  yPos += 10;

  doc.setFontSize(12);
  const totalMessages = analysisData.analysisStats?.totalMessages || 0;
  const activeUsers = analysisData.analysisStats?.activeUsers || 0;
  const topKeyword = analysisData.keywordData?.topKeywords?.[0]?.keyword || 'ì—†ìŒ';
  const mostActiveUser = analysisData.participationData?.userStats?.[0]?.username || 'ì—†ìŒ';

  doc.text(`â€¢ ì´ ì±„íŒ…ë°©ì€ ì´ ${totalMessages}ê°œì˜ ë©”ì‹œì§€ê°€ êµí™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 25, yPos);
  yPos += 7;
  doc.text(`â€¢ ${activeUsers}ëª…ì˜ ì‚¬ìš©ìê°€ í™œë°œíˆ ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤.`, 25, yPos);
  yPos += 7;
  doc.text(`â€¢ ê°€ì¥ ë§ì´ ì‚¬ìš©ëœ í‚¤ì›Œë“œëŠ” "${topKeyword}" ì…ë‹ˆë‹¤.`, 25, yPos);
  yPos += 7;
  doc.text(`â€¢ ê°€ì¥ í™œë°œí•œ ì‚¬ìš©ìëŠ” "${mostActiveUser}" ì…ë‹ˆë‹¤.`, 25, yPos);
  yPos += 15;

  // í‘¸í„°
  doc.setFontSize(8);
  doc.text('Generated by FlowChat Analytics', pageWidth / 2, pageHeight - 10, { align: 'center' });

  // PDF ë‹¤ìš´ë¡œë“œ
  const fileName = `${roomName}_ë¶„ì„ë³´ê³ ì„œ_${new Date().toISOString().split('T')[0]}.pdf`;
  doc.save(fileName);
};

export const exportElementToPDF = async (elementId, fileName) => {
  try {
    const element = document.getElementById(elementId);
    if (!element) {
      throw new Error('Element not found');
    }

    // HTML ìš”ì†Œë¥¼ ìº”ë²„ìŠ¤ë¡œ ë³€í™˜
    const canvas = await html2canvas(element, {
      scale: 2, // í•´ìƒë„ í–¥ìƒ
      useCORS: true,
      allowTaint: true,
    });

    const imgData = canvas.toDataURL('image/png');
    const pdf = new jsPDF();
    const pdfWidth = pdf.internal.pageSize.getWidth();
    const pdfHeight = pdf.internal.pageSize.getHeight();
    
    // ì´ë¯¸ì§€ ë¹„ìœ¨ ê³„ì‚°
    const imgWidth = canvas.width;
    const imgHeight = canvas.height;
    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
    
    const finalWidth = imgWidth * ratio;
    const finalHeight = imgHeight * ratio;
    
    // PDFì— ì´ë¯¸ì§€ ì¶”ê°€
    pdf.addImage(
      imgData, 
      'PNG', 
      (pdfWidth - finalWidth) / 2, 
      (pdfHeight - finalHeight) / 2, 
      finalWidth, 
      finalHeight
    );
    
    pdf.save(fileName);
  } catch (error) {
    console.error('PDF export error:', error);
    throw new Error('PDF ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

export const exportChartsToPDF = async (charts, roomName) => {
  const doc = new jsPDF();
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  let yPos = 20;

  // ì œëª©
  doc.setFontSize(20);
  doc.text(`${roomName} ì°¨íŠ¸ ë³´ê³ ì„œ`, pageWidth / 2, yPos, { align: 'center' });
  yPos += 15;

  doc.setFontSize(10);
  doc.text(`ìƒì„±ì¼: ${new Date().toLocaleString('ko-KR')}`, pageWidth / 2, yPos, { align: 'center' });
  yPos += 20;

  // ê° ì°¨íŠ¸ë¥¼ ìº¡ì²˜í•˜ê³  PDFì— ì¶”ê°€
  for (let i = 0; i < charts.length; i++) {
    const chart = charts[i];
    const element = document.getElementById(chart.id);
    
    if (element) {
      try {
        const canvas = await html2canvas(element, {
          scale: 1,
          useCORS: true,
          allowTaint: true,
        });

        const imgData = canvas.toDataURL('image/png');
        
        // ìƒˆ í˜ì´ì§€ ì¶”ê°€ (ì²« ë²ˆì§¸ ì°¨íŠ¸ ì œì™¸)
        if (i > 0) {
          doc.addPage();
          yPos = 20;
        }

        // ì°¨íŠ¸ ì œëª©
        doc.setFontSize(14);
        doc.text(chart.title, pageWidth / 2, yPos, { align: 'center' });
        yPos += 15;

        // ì´ë¯¸ì§€ í¬ê¸° ê³„ì‚°
        const imgWidth = canvas.width;
        const imgHeight = canvas.height;
        const maxWidth = pageWidth - 40;
        const maxHeight = pageHeight - 80;
        const ratio = Math.min(maxWidth / imgWidth, maxHeight / imgHeight);
        
        const finalWidth = imgWidth * ratio;
        const finalHeight = imgHeight * ratio;
        
        // ì´ë¯¸ì§€ ì¶”ê°€
        doc.addImage(
          imgData, 
          'PNG', 
          (pageWidth - finalWidth) / 2, 
          yPos, 
          finalWidth, 
          finalHeight
        );
        
      } catch (error) {
        console.error('Chart capture error:', error);
      }
    }
  }

  // PDF ë‹¤ìš´ë¡œë“œ
  const fileName = `${roomName}_ì°¨íŠ¸ë³´ê³ ì„œ_${new Date().toISOString().split('T')[0]}.pdf`;
  doc.save(fileName);
};